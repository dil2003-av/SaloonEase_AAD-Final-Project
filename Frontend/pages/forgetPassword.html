<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forgot Password - SaloonEase</title>

  <!-- Bootstrap -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      background-color: #fff3f5;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .card {
      width: 420px;
      border-radius: 12px;
      box-shadow: 0px 6px 15px rgba(0,0,0,0.1);
    }
    h4 {
      font-weight: 600;
      color: #333;
    }
  </style>
</head>
<body>

  <div class="card p-4">
    <h4 class="mb-3 text-center">Forgot Password</h4>

<!-- Step 1: Request OTP -->
<div id="step-request">
  <div class="mb-4">
    <label for="fp-email" class="form-label fw-semibold">Email Address</label>
    <input 
      id="fp-email" 
      class="form-control form-control-lg shadow-sm" 
      type="email" 
      placeholder="you@example.com" 
      required
    >
    <div class="form-text text-muted mt-1">
      Enter the email linked to your account.
    </div>
  </div>
  <button 
    id="btn-request-otp" 
    class="btn btn-primary btn-lg w-100 shadow-sm rounded-pill">
    <i class="bi bi-envelope-paper me-2"></i> Send OTP
  </button>
</div>

    
  <div id="step-reset" style="display:none;">
    <div class="mb-3">
      <label for="fp-otp" class="form-label fw-semibold">OTP</label>
      <input id="fp-otp" class="form-control form-control-lg shadow-sm" type="text" placeholder="Enter 6-digit OTP">
    </div>
    <div class="mb-3">
      <label for="fp-password" class="form-label fw-semibold">New Password</label>
      <input id="fp-password" class="form-control form-control-lg shadow-sm" type="password" placeholder="New password">
    </div>
    <div class="mb-4">
      <label for="fp-confirm" class="form-label fw-semibold">Confirm Password</label>
      <input id="fp-confirm" class="form-control form-control-lg shadow-sm" type="password" placeholder="Confirm password">
    </div>
    <div class="d-flex gap-2">
      <button id="btn-verify-reset" class="btn btn-success btn-lg w-100 shadow-sm rounded-pill">
        <i class="bi bi-shield-lock me-2"></i> Verify & Reset
      </button>
      <button id="btn-back" class="btn btn-outline-secondary btn-lg w-100 shadow-sm rounded-pill">
        <i class="bi bi-arrow-left-circle me-2"></i> Back
      </button>
    </div>
  </div>
</div>


  <script>
    const API_BASE = "http://localhost:8080/auth"; // backend base URL

    const stepRequest = document.getElementById('step-request');
    const stepReset = document.getElementById('step-reset');

    // Step 1: Send OTP
    document.getElementById('btn-request-otp').addEventListener('click', async () => {
      const email = document.getElementById('fp-email').value.trim();
      if (!email) {
        Swal.fire({ icon:'warning', title:'Please enter your email' });
        return;
      }

      Swal.fire({
        title: 'Please wait...',
        text: 'Sending OTP to your email',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      try {
        const res = await fetch(`${API_BASE}/forgot-password`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ email })
        });

        if (!res.ok) {
          const err = await res.text();
          throw new Error(err || 'Request failed');
        }

        Swal.fire({
          icon: 'success',
          title: 'OTP Sent!',
          text: 'Check your email for the OTP'
        });

        stepRequest.style.display = 'none';
        stepReset.style.display = 'block';

      } catch (err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Failed to send OTP'
        });
      }
    });

    // Step 2: Verify OTP & Reset Password
    document.getElementById('btn-verify-reset').addEventListener('click', async () => {
      const email = document.getElementById('fp-email').value.trim();
      const otp = document.getElementById('fp-otp').value.trim();
      const password = document.getElementById('fp-password').value;
      const confirm = document.getElementById('fp-confirm').value;

      if (!otp || !password || !confirm) {
        Swal.fire({ icon:'warning', title:'Please fill all fields' });
        return;
      }
      if (password !== confirm) {
        Swal.fire({ icon:'warning', title:'Passwords do not match' });
        return;
      }

      Swal.fire({
        title: 'Please wait...',
        text: 'Resetting your password',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      try {
        const res = await fetch(`${API_BASE}/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ 
            email: email, 
            otp: otp, 
            newPassword: password 
          })
        });

        if (!res.ok) {
          const err = await res.text();
          throw new Error(err || 'Reset failed');
        }

        Swal.fire({
          icon: 'success',
          title: 'Password Reset Successful',
          text: 'You can now log in with your new password'
        }).then(() => window.location.href = '../pages/login.html');

      } catch (err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Failed to reset password'
        });
      }
    });

    // Back button
    document.getElementById('btn-back').addEventListener('click', () => {
      stepReset.style.display = 'none';
      stepRequest.style.display = 'block';
    });
  </script>

</body>
</html>
